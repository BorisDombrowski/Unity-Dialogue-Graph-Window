# Граф диалогового дерева
**1. Интерфейс окна постороения диалога**

![](https://i.imgur.com/1peiQvM.png)

Окно построения графа содержит следующие элементы:
1. Поле ввода имени файла
2. Кнопки сохранения/загрузки файла
3. Кнопку создания нода диалога
4. Рабочее поле, непосредственно в котором создается граф
5. Мини-карту рабочего поля

**2. Построение дерева диалога**

Изначально окно построения дерева содержит точку входа - нод графа, который содуржит единственный исходящий порт, к которому нужно подсоединить первый нод диалога.

Чтобы создать нод диалога необходимо нажать кнопку Create Node в тулбаре окна, либо вызвать контекстное меню нажатием ПКМ по рабочей области и выбрать Create Node/Dialogue Node.

![](https://i.imgur.com/zoHFnCd.png)

Нод диалога содержит в себе следующие элементы:
1. Входящий порт (поддерживает множественное подсоединение)
2. Полле ввода текста диалога (фраза, которую в этом ноде говорит NPC)
3. Кнопка добавления варианта ответа
4. Список полей вариантов ответа
5. Кнопка добавления связанных с нодом значений
6. Список связанных с нодом значений

![](https://i.imgur.com/E3OHYzA.png)

Каждая строка варианта ответа содержит следующие элементы:
1. Имя связанного с вариантом ответа параметра
2. Значение связанного с вариантом ответа параметра
*Поля 1 и 2 нужно заполнять, если необходимо, чтобы вариант ответа отображался в зависимости от значения какой-либо внешней переменной, иначе эти поля нужно оставить пустыми*
3. Текст варианта ответа (фраза, которую произносит при выборе персонаж игрока)
4. Исходящий порт (через него происходит подключение к ноду, к которому ведет данный вариант ответа)

![](https://i.imgur.com/nq3IXOX.png)

Область связанных с нодом значений содержит следующие элементы:
1. Кнопка добавления нового значения
2. Поля ввода имени значения (не стоит использовать пустое имя)
3. Поле ввода значения
*Данная часть нода используется, если необходимо, чтобы при переходе к данному ноду изменялись какие-либо внешние значения*

Готовое диалоговое дерево имеет следующий вид:

![](https://i.imgur.com/sQXDAz5.png)

Точкой завершения из диалога может являться любой нод, у которого нет вариантов ответа.

**3. Сохранение и загрузка дерева диалога**

![](https://i.imgur.com/1Vk2sap.png)

Для сохранения диалога необходимо ввести называние его файла в соответствующее поле и нажать кнопку "Save". Для загрузки файла необходимо ввести имя файла в поле и нажать кнопку "Load". 
(Пока что было решено оставить такой архаичный способ сохранения/загрузки, при необходимости его можно изменить)

> ВАЖНО: Окно диалога перезагружается и сбрасывается в дефолтное состояние, если в процессе работы были внесены изменения в какие-либо скрипты проекта, поэтому стоит сохранять изменения почаще.

Диалоговое дерево сохраняется в виде класса Dialogue Container (наследуется от Scriptable Object) в папку Assets/Resources/Dialogues. Если данной папки нет в проекте, она создастся автоматически при сохранении дерева диалога.

Дерево, которое содержит только точку входа, не будет сохраняться в папку ассетов.

**4. Имплементация диалога в геймплей**

Как было сказано в прошлой главе, дерево диалога сохраняется в папку с ассетами, как экземпляр класса Dialogue Container (наследуется от Scriptable Object). 

Из-за некоторых особенностей Unity, данный класс (и все его составляющие) был вынесен во внешнюю библиотеку Dialogue System Container. Диаграмма классов Dialogue Container'а выглядит следующим образом:

![](https://i.imgur.com/ZlwSN2s.png)

Dialogue Container содержит в себе два списка: Nodes - список моделей всех нодов дерева и NodeLinks - список всех соединений между нодами.

Чтобы работать с классом контейнера, необходимо подключить пространство имен
```
using Frameblade.DialogueSystem.Container
```

Способ взаимодействия с контейнером может отличаться в зависимости от задачи, но в общем случае переходы между нодами происходят путем сопоставления GUID'ов нодов из списка нодов со ссылками, представленными в списке моделей соединений.